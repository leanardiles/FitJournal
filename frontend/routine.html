<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitJournal - Routine</title>
    <link rel="stylesheet" href="css/paper.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navigation Header -->
    <header class="text-center">
        <div class="margin-top">
            <img src="images/logo_only.png" alt="FitJournal Logo" style="max-width: 80px;">
        </div>
        
        <nav class="margin-top">
            <button onclick="window.location.href='dashboard.html'">Dashboard</button>
            <button onclick="window.location.href='profile.html'">Profile</button>
            <button onclick="window.location.href='exercises.html'">Exercises</button>
            <button onclick="window.location.href='routine.html'" class="active">Routine</button>
            <button onclick="window.location.href='getwod.html'">Get WOD</button>
        </nav>
    </header>

    <!-- Routine Content -->
    <main class="container margin-top">
        <h3 class="text-center">Build Your Routine</h3>
        
        <!-- Step 1: Days per Week -->
        <div id="step-1" class="routine-step">
            <h3>How many days per week do you want to train?</h3>
            <div class="days-selector">
                <button type="button" class="day-btn" data-days="1">1</button>
                <button type="button" class="day-btn" data-days="2">2</button>
                <button type="button" class="day-btn" data-days="3">3</button>
                <button type="button" class="day-btn" data-days="4">4</button>
                <button type="button" class="day-btn" data-days="5">5</button>
                <button type="button" class="day-btn" data-days="6">6</button>
                <button type="button" class="day-btn" data-days="7">7</button>
            </div>
        </div>
        
        <!-- Step 2: Muscle Groups per Day -->
        <div id="step-2" class="routine-step" style="display: none; margin-top: 3rem;">
            <h3>Select muscle groups for each day:</h3>
            
            <div id="days-container">
                <!-- Days will be dynamically generated here -->
            </div>
            
            <div style="text-align: center; margin-top: 2rem;">
                <button id="save-routine-btn" class="btn-primary" style="padding: 0.5rem 3rem;">Save Routine</button>
                <button id="cancel-btn" class="btn-secondary" style="padding: 0.5rem 3rem; margin-left: 1rem;">Cancel</button>
            </div>
        </div>
        
        <!-- Current Routine Display -->
        <div id="current-routine" style="margin-top: 3rem; display: none;">
            <h3>Your Current Routine</h3>
            <div id="routine-display"></div>
            <button id="edit-routine-btn" class="btn-secondary" style="margin-top: 1rem;">Edit Routine</button>
        </div>
        
        <div id="message" style="margin-top: 1rem; display: none;"></div>
    </main>

    <script src="js/api.js"></script>
    <script>
        // Protect page
        requireLogin();
        
        let selectedDays = 0;
        let routineData = {};
        const muscleGroups = ['Legs', 'Shoulders', 'Chest', 'Glutes', 'Biceps', 'Triceps', 'Back', 'Calves', 'Abs'];
        
        // Load existing routine on page load
        document.addEventListener('DOMContentLoaded', async () => {
            const routine = await getUserRoutine();
            
            if (routine && routine.days_per_week > 0) {
                displayCurrentRoutine(routine);
            }
        });
        
        // Display current routine
        function displayCurrentRoutine(routine) {
            document.getElementById('step-1').style.display = 'none';
            document.getElementById('step-2').style.display = 'none';
            document.getElementById('current-routine').style.display = 'block';
            
            const display = document.getElementById('routine-display');
            let html = `<p><strong>Training ${routine.days_per_week} days per week</strong></p>`;
            
            for (let day = 1; day <= routine.days_per_week; day++) {
                const muscles = routine.routine_days[day] || [];
                html += `
                    <div class="routine-day-display">
                        <strong>Day ${day}:</strong> ${muscles.length > 0 ? muscles.join(', ') : 'Rest day'}
                    </div>
                `;
            }
            
            display.innerHTML = html;
        }
        
        // Day selection buttons
        document.querySelectorAll('.day-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                selectedDays = parseInt(e.target.dataset.days);
                
                // Highlight selected button
                document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('selected'));
                e.target.classList.add('selected');
                
                // Show step 2
                document.getElementById('step-2').style.display = 'block';
                
                // Generate day selectors
                generateDaySelectors(selectedDays);
            });
        });
        
        // Generate muscle group selectors for each day
        function generateDaySelectors(numDays) {
            const container = document.getElementById('days-container');
            container.innerHTML = '';
            
            for (let day = 1; day <= numDays; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day-selector';
                dayDiv.innerHTML = `
                    <h4>Day ${day}</h4>
                    <div class="muscle-group-buttons" data-day="${day}">
                        ${muscleGroups.map(muscle => `
                            <button type="button" 
                                    class="muscle-btn" 
                                    data-day="${day}" 
                                    data-muscle="${muscle}">
                                ${muscle}
                            </button>
                        `).join('')}
                    </div>
                    <div class="selected-muscles" data-day="${day}">
                        <strong>Selected:</strong> <span class="muscle-list">None</span>
                    </div>
                `;
                container.appendChild(dayDiv);
            }
            
            // Initialize routine data
            routineData = {};
            for (let day = 1; day <= numDays; day++) {
                routineData[day] = [];
            }
            
            // Add event listeners to muscle buttons
            document.querySelectorAll('.muscle-btn').forEach(button => {
                button.addEventListener('click', toggleMuscleGroup);
            });
        }
        
        // Toggle muscle group selection
        function toggleMuscleGroup(e) {
            const day = parseInt(e.target.dataset.day);
            const muscle = e.target.dataset.muscle;
            
            if (routineData[day].includes(muscle)) {
                // Remove muscle
                routineData[day] = routineData[day].filter(m => m !== muscle);
                e.target.classList.remove('selected');
            } else {
                // Add muscle
                routineData[day].push(muscle);
                e.target.classList.add('selected');
            }
            
            // Update display
            updateSelectedMuscles(day);
        }
        
        // Update selected muscles display
        function updateSelectedMuscles(day) {
            const muscleList = document.querySelector(`.selected-muscles[data-day="${day}"] .muscle-list`);
            if (routineData[day].length > 0) {
                muscleList.textContent = routineData[day].join(', ');
            } else {
                muscleList.textContent = 'None';
            }
        }
        
        // Save routine
        document.getElementById('save-routine-btn').addEventListener('click', async () => {
            // Validate that at least one day has muscle groups
            let hasSelection = false;
            for (let day in routineData) {
                if (routineData[day].length > 0) {
                    hasSelection = true;
                    break;
                }
            }
            
            if (!hasSelection) {
                alert('Please select at least one muscle group for at least one day');
                return;
            }
            
            // Prepare data for API
            const apiData = {
                days_per_week: selectedDays,
                routine_days: []
            };
            
            for (let day = 1; day <= selectedDays; day++) {
                apiData.routine_days.push({
                    day_number: day,
                    muscle_groups: routineData[day]
                });
            }
            
            // Save to backend
            const result = await saveUserRoutine(apiData);
            
            if (result) {
                // Show success message
                const message = document.getElementById('message');
                message.textContent = 'Routine saved successfully!';
                message.className = 'alert alert-success';
                message.style.display = 'block';
                
                // Reload and display routine
                setTimeout(async () => {
                    const routine = await getUserRoutine();
                    displayCurrentRoutine(routine);
                    message.style.display = 'none';
                }, 1500);
            }
        });
        
        // Cancel button
        document.getElementById('cancel-btn').addEventListener('click', async () => {
            const routine = await getUserRoutine();
            if (routine && routine.days_per_week > 0) {
                displayCurrentRoutine(routine);
            } else {
                document.getElementById('step-1').style.display = 'block';
                document.getElementById('step-2').style.display = 'none';
            }
        });
        
        // Edit routine button
        document.getElementById('edit-routine-btn').addEventListener('click', () => {
            document.getElementById('current-routine').style.display = 'none';
            document.getElementById('step-1').style.display = 'block';
            document.getElementById('step-2').style.display = 'none';
        });
    </script>
</body>
</html>