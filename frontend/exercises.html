<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitJournal - Exercises</title>
    <link rel="stylesheet" href="css/paper.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navigation Header -->
    <header class="text-center">
        <div class="margin-top">
            <img src="images/logo_only.png" alt="FitJournal Logo" style="max-width: 80px;">
        </div>
        
        <nav class="margin-top">
            <button onclick="window.location.href='dashboard.html'">Dashboard</button>
            <button onclick="window.location.href='profile.html'">Profile</button>
            <button onclick="window.location.href='exercises.html'">Exercises</button>
            <button onclick="window.location.href='routine.html'">Routine</button>
            <button onclick="window.location.href='calendar.html'">Calendar</button>
            <button onclick="window.location.href='getwod.html'">Get WOD</button>
        </nav>
        
        <!-- User Info & Logout -->
        <div style="position: absolute; top: 1rem; right: 2rem; display: flex; align-items: center; gap: 1rem;">
            <span id="user-email" style="color: #ffffff; font-size: 0.9rem;"></span>
            <button onclick="logout()" style="padding: 0.4rem 1rem; font-size: 0.85rem;">
                Logout
            </button>
        </div>
    </header>

    <!-- Exercises Content -->
    <main class="container-fluid margin-top">
        <h3 class="text-center">Your Exercises</h3>
        
        <div class="row">
            <!-- Left Side: Muscle Group Tabs (Vertical) -->
            <div class="col-3">
                <div class="tabs" style="display: flex; flex-direction: column;">
                    <input id="tab-legs" type="radio" name="muscle-group" value="Legs" checked>
                    <label for="tab-legs" class="muscle-tab">Legs</label>
                    
                    <input id="tab-shoulders" type="radio" name="muscle-group" value="Shoulders">
                    <label for="tab-shoulders" class="muscle-tab">Shoulders</label>
                    
                    <input id="tab-chest" type="radio" name="muscle-group" value="Chest">
                    <label for="tab-chest" class="muscle-tab">Chest</label>
                    
                    <input id="tab-glutes" type="radio" name="muscle-group" value="Glutes">
                    <label for="tab-glutes" class="muscle-tab">Glutes</label>
                    
                    <input id="tab-biceps" type="radio" name="muscle-group" value="Biceps">
                    <label for="tab-biceps" class="muscle-tab">Biceps</label>
                    
                    <input id="tab-triceps" type="radio" name="muscle-group" value="Triceps">
                    <label for="tab-triceps" class="muscle-tab">Triceps</label>
                    
                    <input id="tab-back" type="radio" name="muscle-group" value="Back">
                    <label for="tab-back" class="muscle-tab">Back</label>
                    
                    <input id="tab-calves" type="radio" name="muscle-group" value="Calves">
                    <label for="tab-calves" class="muscle-tab">Calves</label>
                    
                    <input id="tab-abs" type="radio" name="muscle-group" value="Abs">
                    <label for="tab-abs" class="muscle-tab">Abs</label>
                </div>
            </div>
            
            <!-- Right Side: Exercise List -->
            <div class="col-9">
                <div id="exercise-list">
                    <h4 id="muscle-group-title">Legs Exercises</h4>
                    
                    <!-- Save Changes Button -->
                    <div style="text-align: right; margin-bottom: 1rem;">
                        <button id="save-changes-btn" class="btn-primary" style="padding: 0.75rem 2rem; font-size: 1rem;">
                            SAVE
                        </button>
                    </div>
                    <!-- Exercise Table -->
                    <table class="table-hover">
                        <thead>
                            <tr>
                                <th>Exercise Name</th>
                                <th id="weight-header">Weight</th>
                                <th>Link</th>
                                <th>Include in Routine</th>
                            </tr>
                        </thead>
                        <tbody id="exercise-table-body">
                            <!-- Exercises will be loaded here dynamically -->
                        </tbody>
                    </table>
                    
                    <div id="loading" style="text-align: center; padding: 2rem; display: none;">
                        Loading exercises...
                    </div>
                    
                    <div id="no-exercises" style="text-align: center; padding: 2rem; display: none;">
                        No exercises found for this muscle group.
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/api.js"></script>
    <script>
        // Protect page
        requireLogin();
        
        // Track changes
        let pendingChanges = {
            weights: {},      // { exercise_id: new_weight }
            routineToggles: {} // { exercise_id: new_is_in_routine }
        };
        let hasUnsavedChanges = false;

        let allExercises = [];
        let currentMuscleGroup = 'Legs';

        // Set weight unit based on user preference
        async function setWeightUnit() {
            const profile = await getUserProfile();
            const weightHeader = document.getElementById('weight-header');
            
            if (profile && profile.user_unit_preference === 'imperial') {
                weightHeader.textContent = 'Weight (lbs)';
            } else {
                weightHeader.textContent = 'Weight (kg)';
            }
        }
        
        // Load exercises on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await setWeightUnit();
            await loadExercises();
            displayExercises(currentMuscleGroup);
        });
        
        // Load all exercises from API
        async function loadExercises() {
            document.getElementById('loading').style.display = 'block';
            allExercises = await getUserExercises();
            document.getElementById('loading').style.display = 'none';
        }
        
        // Display exercises for selected muscle group
        function displayExercises(muscleGroup) {
            const tbody = document.getElementById('exercise-table-body');
            const title = document.getElementById('muscle-group-title');
            const noExercises = document.getElementById('no-exercises');
            
            // Update title
            title.textContent = `${muscleGroup} Exercises`;
            
            // Filter exercises by muscle group
            const filtered = allExercises.filter(ex => ex.exercise_muscle_group === muscleGroup);
            
            if (filtered.length === 0) {
                tbody.innerHTML = '';
                noExercises.style.display = 'block';
                return;
            }
            
            noExercises.style.display = 'none';
            
            // Build table rows
            tbody.innerHTML = filtered.map(exercise => `
                <tr data-exercise-id="${exercise.exercise_id}">
                    <td>${exercise.exercise_name}</td>
                    <td>
                        <input type="number" 
                               class="weight-input" 
                               value="${exercise.exercise_user_current_weight || ''}" 
                               placeholder="0.00"
                               step="0.5"
                               min="0"
                               data-exercise-id="${exercise.exercise_id}"
                               style="width: 100px;">
                    </td>
                    <td>
                        ${exercise.exercise_link ? 
                            `<a href="${exercise.exercise_link}" target="_blank" style="color: #5595ce;">View</a>` : 
                            '-'}
                    </td>
                    <td>
                        <input type="checkbox" 
                               class="include-checkbox"
                               ${exercise.exercise_is_in_routine ? 'checked' : ''}
                               data-exercise-id="${exercise.exercise_id}">
                    </td>
                </tr>
            `).join('');
            
            // Add event listeners for weight inputs
            document.querySelectorAll('.weight-input').forEach(input => {
                input.addEventListener('blur', (e) => {
                    updateExerciseWeight(e.target.dataset.exerciseId, parseFloat(e.target.value) || 0);
                });
            });

            // Add event listeners for include checkboxes
            document.querySelectorAll('.include-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    updateExerciseInclude(e.target.dataset.exerciseId, e.target.checked);
                });
            });
        }
        
        // Update exercise weight
        function updateExerciseWeight(exerciseId, weight) {
            // Track the change (don't save yet)
            pendingChanges.weights[exerciseId] = weight;
            hasUnsavedChanges = true;
            
            // Update local data for display
            const exercise = allExercises.find(ex => ex.exercise_id == exerciseId);
            if (exercise) {
                exercise.exercise_user_current_weight = weight;
            }
            
            // Update button appearance
            updateSaveButton();
        }

        // Update exercise include status
        function updateExerciseInclude(exerciseId, isIncluded) {
            // Track the change (don't save yet)
            pendingChanges.routineToggles[exerciseId] = isIncluded;
            hasUnsavedChanges = true;
            
            // Update local data for display
            const exercise = allExercises.find(ex => ex.exercise_id == exerciseId);
            if (exercise) {
                exercise.exercise_is_in_routine = isIncluded;
            }
            
            // Update button appearance
            updateSaveButton();
        }
        
        // Handle tab changes
        document.querySelectorAll('input[name="muscle-group"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                currentMuscleGroup = e.target.value;
                displayExercises(currentMuscleGroup);
            });
        });
        // Load user first name on page load
        document.addEventListener('DOMContentLoaded', async () => {
            let userName = getCurrentUserFirstName();
            
            // If first name not in localStorage, fetch from profile
            if (!userName) {
                const userId = getCurrentUserId();
                const profile = await getUserProfile();
                if (profile && profile.user_first_name) {
                    userName = profile.user_first_name;
                    localStorage.setItem('user_first_name', userName);
                } else {
                    userName = getCurrentUserEmail(); // Fallback to email if no first name
                }
            }
            
            if (userName) {
                document.getElementById('user-email').textContent = userName;
            }
        });

        // Update save button appearance
        function updateSaveButton() {
            const btn = document.getElementById('save-changes-btn');
            if (hasUnsavedChanges) {
                btn.style.backgroundColor = '#5595ce';
                btn.textContent = 'SAVE *';
            } else {
                btn.style.backgroundColor = '#4a4a4a';
                btn.textContent = 'SAVE';
            }
        }

        // Save all changes
        document.getElementById('save-changes-btn').addEventListener('click', async () => {
            if (!hasUnsavedChanges) {
                alert('No changes to save');
                return;
            }
            
            const userId = getCurrentUserId();
            const btn = document.getElementById('save-changes-btn');
            
            try {
                btn.textContent = 'Saving...';
                btn.disabled = true;
                
                let savedCount = 0;
                
                // Collect all changes and merge them
                const exercisesToUpdate = new Map();

                // Add weight changes
                for (const [exerciseId, weight] of Object.entries(pendingChanges.weights)) {
                    if (!exercisesToUpdate.has(exerciseId)) {
                        const exercise = allExercises.find(ex => ex.exercise_id == exerciseId);
                        exercisesToUpdate.set(exerciseId, { ...exercise });
                    }
                    exercisesToUpdate.get(exerciseId).exercise_user_current_weight = weight;
                }

                // Add routine toggle changes
                for (const [exerciseId, isInRoutine] of Object.entries(pendingChanges.routineToggles)) {
                    if (!exercisesToUpdate.has(exerciseId)) {
                        const exercise = allExercises.find(ex => ex.exercise_id == exerciseId);
                        exercisesToUpdate.set(exerciseId, { ...exercise });
                    }
                    exercisesToUpdate.get(exerciseId).exercise_is_in_routine = isInRoutine;
                }

                // Save all updated exercises
                for (const [exerciseId, exerciseData] of exercisesToUpdate) {
                    const response = await fetch(`${API_URL}/exercises/${exerciseId}?user_id=${userId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            exercise_name: exerciseData.exercise_name,
                            exercise_muscle_group: exerciseData.exercise_muscle_group,
                            exercise_user_current_weight: exerciseData.exercise_user_current_weight,
                            exercise_is_in_routine: exerciseData.exercise_is_in_routine,
                            exercise_link: exerciseData.exercise_link || null,
                            comments: exerciseData.comments || null
                        })
                    });
                    
                    if (response.ok) {
                        savedCount++;
                    } else {
                        console.error(`Failed to update exercise ${exerciseId}:`, await response.text());
                    }
                }
                
                // Clear pending changes
                pendingChanges = { weights: {}, routineToggles: {} };
                hasUnsavedChanges = false;
                
                // Update button
                updateSaveButton();
                btn.disabled = false;
                
                alert(`${savedCount} change(s) saved successfully!`);
                
            } catch (error) {
                console.error('Error saving changes:', error);
                alert('Error saving changes. Please try again.');
                btn.textContent = 'SAVE *';
                btn.disabled = false;
            }
        });
    </script>
</body>
</html>