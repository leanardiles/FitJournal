<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitJournal - Get WOD</title>
    <link rel="stylesheet" href="css/paper.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navigation Header -->
    <header class="text-center">
        <div class="margin-top">
            <img src="images/logo_only.png" alt="FitJournal Logo" style="max-width: 80px;">
        </div>
        
        <nav class="margin-top">
            <button onclick="window.location.href='dashboard.html'">Dashboard</button>
            <button onclick="window.location.href='profile.html'">Profile</button>
            <button onclick="window.location.href='exercises.html'">Exercises</button>
            <button onclick="window.location.href='routine.html'">Routine</button>
            <button onclick="window.location.href='calendar.html'">Calendar</button>
            <button onclick="window.location.href='getwod.html'">Get WOD</button>
        </nav>
        
        <!-- User Info & Logout -->
        <div style="position: absolute; top: 1rem; right: 2rem; display: flex; align-items: center; gap: 1rem;">
            <span id="user-email" style="color: #ffffff; font-size: 0.9rem;"></span>
            <button onclick="logout()" style="padding: 0.4rem 1rem; font-size: 0.85rem;">
                Logout
            </button>
        </div>
    </header>

    <!-- Get WOD Content -->
    <main class="container margin-top">
        <h3 class="text-center">Workout of the Day üí™</h3>
        
        <!-- Initial State: Generate Button -->
        <div id="generate-section" style="text-align: center; margin-top: 3rem;">
            <p style="font-size: 1.1rem; margin-bottom: 2rem; color: #ccc;">
                Ready to crush your workout? Generate today's WOD!
            </p>
            <button id="generate-wod-btn" class="btn-primary" style="padding: 1rem 3rem; font-size: 1.1rem;">
                üèãÔ∏è Generate WOD
            </button>
        </div>
        
        <!-- Workout Display: Hidden initially -->
        <div id="workout-section" style="display: none;">
            <!-- Centered Container -->
            <div style="max-width: 90%; width: fit-content; min-width: 700px; margin: 0 auto;">
                
                <!-- Workout Info -->
                <div id="workout-info" style="background-color: #2a2a2a; padding: 1rem; border-radius: 4px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <p style="margin: 0; color: #5595ce; font-weight: bold; font-size: 1.1rem;">
                            üìÖ <span id="workout-date-info"></span>
                        </p>
                        <p style="margin: 0.5rem 0 0 0; color: #ccc; font-size: 0.95rem;">
                            <span id="routine-day-info"></span>
                        </p>
                    </div>
                    <div>
                        <button id="mark-complete-btn" class="btn-primary" style="padding: 0.75rem 2rem; font-size: 1rem; width: fit-content; white-space: nowrap;">
                            <span id="checkbox-icon">‚òê</span> Mark as Complete
                        </button>
                    </div>
                </div>
                
                <!-- Exercise Table -->
                <div style="background-color: #2a2a2a; padding: 1.5rem; border-radius: 4px; margin-bottom: 1rem;">
                    <table id="workout-table" style="width: 100%; color: #ffffff;">
                        <thead>
                            <tr style="border-bottom: 2px solid #444;">
                                <th style="text-align: left; padding: 0.75rem; font-size: 0.95rem; color: #ffffff;">Exercise</th>
                                <th style="text-align: center; padding: 0.75rem; font-size: 0.95rem; width: 150px; color: #ffffff;">Weight (<span id="unit-label">kg</span>)</th>
                                <th style="text-align: center; padding: 0.75rem; font-size: 0.95rem; width: 120px; color: #ffffff;">Sets</th>
                                <th style="text-align: center; padding: 0.75rem; font-size: 0.95rem; width: 120px; color: #ffffff;">Reps</th>
                            </tr>
                        </thead>
                        <tbody id="workout-table-body">
                            <!-- Exercises will be loaded here -->
                        </tbody>
                    </table>
                </div>
                
            </div>
            
            <!-- Action Buttons (outside container, centered) -->
            <div style="text-align: center; margin-top: 2rem;">
                <button id="cancel-btn" class="btn-secondary" style="padding: 0.75rem 2rem; font-size: 1rem;">
                    Cancel
                </button>
            </div>
        </div>
        
        <!-- Success Message -->
        <div id="success-section" style="display: none; text-align: center; margin-top: 3rem;">
            <div style="background-color: #4caf50; padding: 2rem; border-radius: 8px; max-width: 600px; margin: 0 auto;">
                <h2 style="color: white; margin: 0 0 1rem 0;">üéâ Workout Complete!</h2>
                <p style="color: white; font-size: 1.1rem; margin: 0;">
                    Great job! Your workout has been logged.
                </p>
            </div>
            <button onclick="window.location.href='dashboard.html'" class="btn-primary" style="margin-top: 2rem; padding: 0.75rem 2rem;">
                Back to Dashboard
            </button>
        </div>
        
        <div id="message" style="margin-top: 1rem; display: none;"></div>
    </main>

    <script src="js/api.js"></script>
    <script>
        // Protect page
        requireLogin();
        
        let currentWorkoutData = null;
        let selectedExercises = [];
        let isWorkoutCompleted = false;
        
        // Generate WOD button
        document.getElementById('generate-wod-btn').addEventListener('click', async () => {
            await generateWorkout();
        });

        // Mark as Complete button
         document.getElementById('mark-complete-btn').addEventListener('click', async () => {
            if (!isWorkoutCompleted) {
                await completeWorkout();
            }
        });
        
        // Cancel button
        document.getElementById('cancel-btn').addEventListener('click', () => {
            // Show generate section again
            document.getElementById('generate-section').style.display = 'block';
            document.getElementById('workout-section').style.display = 'none';
        });
        
        // Generate workout
        async function generateWorkout() {
            const userId = getCurrentUserId();
            
            try {
                // Show loading
                document.getElementById('generate-wod-btn').textContent = 'Loading...';
                document.getElementById('generate-wod-btn').disabled = true;
                
                // Get workout state (which day user is on)
                const stateResponse = await fetch(`${API_URL}/workout/state/${userId}`);
                const state = await stateResponse.json();
                
                // Get routine to know muscle groups for current day
                const routineResponse = await fetch(`${API_URL}/routine/${userId}`);
                const routine = await routineResponse.json();
                const muscleGroupsForCurrentDay = routine.routine_days[state.current_day_number] || [];
                
                // Get selected exercises from calendar
                const selectionsResponse = await fetch(`${API_URL}/next-workout/selections/${userId}`);
                const selections = await selectionsResponse.json();
                
                // Filter only selected exercises
                selectedExercises = selections.filter(s => s.is_selected);
                
                if (selectedExercises.length === 0) {
                    showMessage('No exercises selected! Please select exercises in the Calendar page.', 'error');
                    document.getElementById('generate-wod-btn').textContent = 'üèãÔ∏è Generate WOD';
                    document.getElementById('generate-wod-btn').disabled = false;
                    return;
                }
                
                // Get full exercise details
                const allExercises = await getUserExercises();
                const workoutExercises = selectedExercises.map(sel => {
                    return allExercises.find(ex => ex.exercise_id === sel.exercise_id);
                }).filter(ex => ex !== undefined);
                
                // FILTER: Only keep exercises that match current day's muscle groups
                const filteredWorkoutExercises = workoutExercises.filter(ex =>
                    muscleGroupsForCurrentDay.includes(ex.exercise_muscle_group)
                );
                
                if (filteredWorkoutExercises.length === 0) {
                    showMessage(`No exercises selected for Day ${state.current_day_number}! Please select exercises for ${muscleGroupsForCurrentDay.join(', ')} in the Calendar page.`, 'error');
                    document.getElementById('generate-wod-btn').textContent = 'üèãÔ∏è Generate WOD';
                    document.getElementById('generate-wod-btn').disabled = false;
                    return;
                }
                
                // Store current workout data
                currentWorkoutData = {
                    day_number: state.current_day_number,
                    muscle_groups: muscleGroupsForCurrentDay,
                    exercises: filteredWorkoutExercises
                };
                
                // Display workout
                displayWorkout(currentWorkoutData);
                
                // Hide generate section, show workout section
                document.getElementById('generate-section').style.display = 'none';
                document.getElementById('workout-section').style.display = 'block';
                
                // Reset button
                document.getElementById('generate-wod-btn').textContent = 'üèãÔ∏è Generate WOD';
                document.getElementById('generate-wod-btn').disabled = false;
                
            } catch (error) {
                console.error('Error generating workout:', error);
                showMessage('Error generating workout. Please try again.', 'error');
                document.getElementById('generate-wod-btn').textContent = 'üèãÔ∏è Generate WOD';
                document.getElementById('generate-wod-btn').disabled = false;
            }
        }
        
        // Display workout in table
        function displayWorkout(workoutData) {
            // Get today's date
            const today = new Date();
            const dateString = formatDateShort(today);

            // Update info section
            document.getElementById('workout-date-info').textContent = dateString;
            document.getElementById('routine-day-info').textContent = `Day ${workoutData.day_number}. Target: ${workoutData.muscle_groups.join(', ')}`;
            
            // Set unit label based on user preference
            getUserProfile().then(profile => {
                if (profile && profile.user_unit_preference === 'imperial') {
                    document.getElementById('unit-label').textContent = 'lbs';
                } else {
                    document.getElementById('unit-label').textContent = 'kg';
                }
            });
            
        // Build table - Group by muscle group
        const tbody = document.getElementById('workout-table-body');
        tbody.innerHTML = '';

        // Group exercises by muscle group
        const exercisesByMuscle = {};
        workoutData.exercises.forEach(exercise => {
            if (!exercisesByMuscle[exercise.exercise_muscle_group]) {
                exercisesByMuscle[exercise.exercise_muscle_group] = [];
            }
            exercisesByMuscle[exercise.exercise_muscle_group].push(exercise);
        });

        // Sort muscle groups alphabetically
        const sortedMuscleGroups = Object.keys(exercisesByMuscle).sort();

        // Build rows with muscle group headers
        let exerciseIndex = 0;
        sortedMuscleGroups.forEach(muscleGroup => {
            // Add muscle group header row
            const muscleHeaderRow = document.createElement('tr');
            muscleHeaderRow.style.borderBottom = '2px solid #444';
            muscleHeaderRow.style.backgroundColor = '#1a1a1a';
            
            const muscleHeaderCell = document.createElement('td');
            muscleHeaderCell.colSpan = 4;
            muscleHeaderCell.style.padding = '0.75rem';
            muscleHeaderCell.style.fontWeight = 'bold';
            muscleHeaderCell.style.color = '#5595ce';
            muscleHeaderCell.style.fontSize = '1rem';
            muscleHeaderCell.textContent = muscleGroup;
            muscleHeaderRow.appendChild(muscleHeaderCell);
            tbody.appendChild(muscleHeaderRow);
            
            // Add exercise rows for this muscle group
            exercisesByMuscle[muscleGroup].forEach(exercise => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #444';
                
                // Exercise name
                const nameCell = document.createElement('td');
                nameCell.style.padding = '1rem 0.75rem';
                nameCell.style.fontWeight = '500';
                nameCell.style.color = '#ffffff';
                nameCell.style.whiteSpace = 'nowrap';
                nameCell.textContent = exercise.exercise_name;
                row.appendChild(nameCell);
                
                // Weight (editable, pre-filled from exercises table)
                const weightCell = document.createElement('td');
                weightCell.style.padding = '1rem 0.75rem';
                weightCell.style.textAlign = 'center';
                const weightInput = document.createElement('input');
                weightInput.type = 'number';
                weightInput.id = `weight-${exerciseIndex}`;
                weightInput.value = exercise.exercise_user_current_weight || '';
                weightInput.placeholder = '0';
                weightInput.step = '0.5';
                weightInput.min = '0';
                weightInput.style.width = '100px';
                weightInput.style.padding = '0.5rem';
                weightInput.style.textAlign = 'center';
                weightInput.style.border = '1px solid #555';
                weightInput.style.borderRadius = '4px';
                weightInput.style.backgroundColor = '#171717';
                weightInput.style.color = '#ffffff';
                weightCell.appendChild(weightInput);
                row.appendChild(weightCell);
                
                // Sets (editable)
                const setsCell = document.createElement('td');
                setsCell.style.padding = '1rem 0.75rem';
                setsCell.style.textAlign = 'center';
                const setsInput = document.createElement('input');
                setsInput.type = 'number';
                setsInput.id = `sets-${exerciseIndex}`;
                setsInput.placeholder = '3';
                setsInput.min = '1';
                setsInput.max = '10';
                setsInput.style.width = '80px';
                setsInput.style.padding = '0.5rem';
                setsInput.style.textAlign = 'center';
                setsInput.style.border = '1px solid #555';
                setsInput.style.borderRadius = '4px';
                setsInput.style.backgroundColor = '#171717';
                setsInput.style.color = '#ffffff';
                setsCell.appendChild(setsInput);
                row.appendChild(setsCell);
                
                // Reps (editable)
                const repsCell = document.createElement('td');
                repsCell.style.padding = '1rem 0.75rem';
                repsCell.style.textAlign = 'center';
                const repsInput = document.createElement('input');
                repsInput.type = 'number';
                repsInput.id = `reps-${exerciseIndex}`;
                repsInput.placeholder = '8';
                repsInput.min = '1';
                repsInput.max = '50';
                repsInput.style.width = '80px';
                repsInput.style.padding = '0.5rem';
                repsInput.style.textAlign = 'center';
                repsInput.style.border = '1px solid #555';
                repsInput.style.borderRadius = '4px';
                repsInput.style.backgroundColor = '#171717';
                repsInput.style.color = '#ffffff';
                repsCell.appendChild(repsInput);
                row.appendChild(repsCell);
                
                tbody.appendChild(row);
                exerciseIndex++;
            });
        });
        }
        
        // Complete workout
        async function completeWorkout() {
            // Validate inputs
            let isValid = true;
            const exercises = [];
            
            currentWorkoutData.exercises.forEach((exercise, index) => {
                const weight = parseFloat(document.getElementById(`weight-${index}`).value) || 0;
                const sets = parseInt(document.getElementById(`sets-${index}`).value) || 0;
                const reps = parseInt(document.getElementById(`reps-${index}`).value) || 0;
                
                exercises.push({
                    exercise_id: exercise.exercise_id,
                    sets_completed: sets,
                    reps_completed: reps,
                    weight_used: weight
                });
            });
            
            if (!isValid) {
                showMessage('Please fill in sets and reps for all exercises', 'error');
                return;
            }
            
            // Send to backend
            const userId = getCurrentUserId();
            
            try {
                const btn = document.getElementById('mark-complete-btn');
                
                // Show saving state
                btn.innerHTML = 'üíæ Saving...';
                btn.disabled = true;
                
                const response = await fetch(`${API_URL}/workout/complete/${userId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        day_number: currentWorkoutData.day_number,
                        exercises: exercises
                    })
                });
                
                if (response.ok) {
                    // Update button to show completed state
                    isWorkoutCompleted = true;
                    btn.innerHTML = '<span id="checkbox-icon">‚úÖ</span> Marked as Complete';
                    btn.style.backgroundColor = '#4caf50';
                    btn.style.cursor = 'default';
                    
                    // Disable all inputs - workout is now locked
                    currentWorkoutData.exercises.forEach((exercise, index) => {
                        document.getElementById(`weight-${index}`).disabled = true;
                        document.getElementById(`sets-${index}`).disabled = true;
                        document.getElementById(`reps-${index}`).disabled = true;
                        
                        // Make inputs visually disabled
                        document.getElementById(`weight-${index}`).style.opacity = '0.6';
                        document.getElementById(`sets-${index}`).style.opacity = '0.6';
                        document.getElementById(`reps-${index}`).style.opacity = '0.6';
                        document.getElementById(`weight-${index}`).style.cursor = 'not-allowed';
                        document.getElementById(`sets-${index}`).style.cursor = 'not-allowed';
                        document.getElementById(`reps-${index}`).style.cursor = 'not-allowed';
                    });
                    
                    showMessage('Workout logged successfully! üéâ', 'success');
                    
                    // Redirect after a delay
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                    
                } else {
                    showMessage('Error saving workout. Please try again.', 'error');
                    btn.innerHTML = '<span id="checkbox-icon">‚òê</span> Mark as Complete';
                    btn.disabled = false;
                }
                
            } catch (error) {
                console.error('Error completing workout:', error);
                showMessage('Network error. Please try again.', 'error');
                const btn = document.getElementById('mark-complete-btn');
                btn.innerHTML = '<span id="checkbox-icon">‚òê</span> Mark as Complete';
                btn.disabled = false;
            }
        }
        
        // Helper: Show message
        function showMessage(text, type) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = type === 'success' ? 'alert alert-success' : 'alert alert-danger';
            message.style.display = 'block';
            
            setTimeout(() => {
                message.style.display = 'none';
            }, 3000);
        }

        // Helper: Format date as "Friday 5 December"
        function formatDateShort(date) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            const dayName = days[date.getDay()];
            const day = date.getDate();
            const monthName = months[date.getMonth()];
            
            return `${dayName} ${day} ${monthName}`;
        }
        // Load user first name on page load
        document.addEventListener('DOMContentLoaded', async () => {
            let userName = getCurrentUserFirstName();
            
            // If first name not in localStorage, fetch from profile
            if (!userName) {
                const userId = getCurrentUserId();
                const profile = await getUserProfile();
                if (profile && profile.user_first_name) {
                    userName = profile.user_first_name;
                    localStorage.setItem('user_first_name', userName);
                } else {
                    userName = getCurrentUserEmail(); // Fallback to email if no first name
                }
            }
            
            if (userName) {
                document.getElementById('user-email').textContent = userName;
            }
        });
    </script>
</body>
</html>