<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitJournal - Calendar</title>
    <link rel="stylesheet" href="css/paper.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Navigation Header -->
    <header class="text-center">
        <div class="margin-top">
            <img src="images/logo_only.png" alt="FitJournal Logo" style="max-width: 80px;">
        </div>
        
        <nav class="margin-top">
            <button onclick="window.location.href='dashboard.html'">Dashboard</button>
            <button onclick="window.location.href='profile.html'">Profile</button>
            <button onclick="window.location.href='exercises.html'">Exercises</button>
            <button onclick="window.location.href='routine.html'">Routine</button>
            <button onclick="window.location.href='calendar.html'" class="active">Calendar</button>
            <button onclick="window.location.href='getwod.html'">Get WOD</button>
        </nav>
    </header>

    <!-- Calendar Content -->
    <main class="container-fluid margin-top">
        <h3 class="text-center">Your Workout Calendar ðŸ“…</h3>
        
        <!-- Day Filter Buttons -->
        <div id="day-filter-container" style="text-align: center; margin-bottom: 1rem;">
            <!-- Buttons will be generated dynamically -->
        </div>
        
        <!-- Current View Info -->
        <div id="current-view-info" style="text-align: center; margin-bottom: 1rem; color: #ccc; font-size: 0.95rem;">
            <!-- Will show: "Currently showing: Day 1 - Chest, Glutes, Abs" -->
        </div>
        
        <!-- Controls -->
        <div style="text-align: center; margin-bottom: 1rem;">
            <button id="generate-next-workout-btn" class="btn-primary">ðŸ¤– Automatic Selection</button>
            <button id="clear-selections-btn" class="btn-secondary">Clear Selection</button>
        </div>
        
        <!-- Calendar Table -->
        <div style="overflow-x: auto;">
            <table id="calendar-table">
                <thead>
                    <tr id="header-row">
                        <!-- Headers will be built by JavaScript -->
                    </tr>
                </thead>
                <tbody id="calendar-body">
                    <tr>
                        <td colspan="13" style="text-align: center; padding: 2rem;">Loading calendar...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div id="message" style="margin-top: 1rem; display: none;"></div>
    </main>

    <script src="js/api.js"></script>
    <script>
        // Protect page
        requireLogin();
        
        let allExercises = [];
        let workoutSessions = [];
        let workoutLogs = [];
        let nextWorkoutSelections = {};
        let userRoutine = null;
        let selectedDays = []; // Array of selected day numbers, e.g., [1, 3] means Day 1 and Day 3
        let filterMode = 'current'; // 'current', 'all', or 'specific' (when days are selected)
        let currentUserDay = 1; // User's current routine day
        const columnsToShow = 10;
        
        // Load calendar on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCalendar();
        });
        
        // Load all data and build calendar
        async function loadCalendar() {
            const userId = getCurrentUserId();
            
            // Load user's routine
            userRoutine = await getUserRoutine();
            
            // Get user's current workout state
            const stateResponse = await fetch(`${API_URL}/workout/state/${userId}`);
            const state = await stateResponse.json();
            currentUserDay = state.current_day_number;
            
            // Load exercises (only those in routine)
            allExercises = await getUserExercises();
            allExercises = allExercises.filter(ex => ex.exercise_is_in_routine);
            
            // Load last 10 workout sessions
            workoutSessions = await getWorkoutSessions(userId, 10);
            
            // Load workout logs for these sessions
            if (workoutSessions.length > 0) {
                const sessionIds = workoutSessions.map(s => s.session_id);
                workoutLogs = await getWorkoutLogsBySessions(userId, sessionIds);
            }
            
            // Load next workout selections
            nextWorkoutSelections = await getNextWorkoutSelections(userId);
            
            // Build day filter buttons
            buildDayFilterButtons();
            
            // Build calendar table
            buildCalendarTable();
        }
        
        // Build day filter toggle buttons
        function buildDayFilterButtons() {
            const container = document.getElementById('day-filter-container');
            container.innerHTML = '';
            
            if (!userRoutine || userRoutine.days_per_week === 0) {
                return;
            }
            
            // "Current Day" button
            const currentDayBtn = document.createElement('button');
            currentDayBtn.textContent = 'Current Day';
            currentDayBtn.className = filterMode === 'current' ? 'btn-primary' : 'btn-secondary';
            currentDayBtn.style.margin = '0 0.5rem';
            currentDayBtn.addEventListener('click', () => {
                filterMode = 'current';
                selectedDays = [];
                loadCalendar();
            });
            container.appendChild(currentDayBtn);
            
            // "All Days" button
            const allDaysBtn = document.createElement('button');
            allDaysBtn.textContent = 'All Days';
            allDaysBtn.className = filterMode === 'all' ? 'btn-primary' : 'btn-secondary';
            allDaysBtn.style.margin = '0 0.5rem';
            allDaysBtn.addEventListener('click', () => {
                filterMode = 'all';
                selectedDays = [];
                loadCalendar();
            });
            container.appendChild(allDaysBtn);
            
            // Day buttons (Day 1, Day 2, etc.) - Multi-select
            for (let day = 1; day <= userRoutine.days_per_week; day++) {
                const dayBtn = document.createElement('button');
                dayBtn.textContent = `Day ${day}`;
                const isSelected = filterMode === 'specific' && selectedDays.includes(day);
                dayBtn.className = isSelected ? 'btn-primary' : 'btn-secondary';
                dayBtn.style.margin = '0 0.5rem';
                dayBtn.addEventListener('click', () => {
                    toggleDaySelection(day);
                });
                container.appendChild(dayBtn);
            }
        }
        
        // Toggle day selection (multi-select logic)
        function toggleDaySelection(day) {
            // Switch to specific mode
            filterMode = 'specific';
            
            // Toggle the day in selection
            if (selectedDays.includes(day)) {
                // Remove day
                selectedDays = selectedDays.filter(d => d !== day);
                
                // If no days selected, default to current day
                if (selectedDays.length === 0) {
                    filterMode = 'current';
                }
            } else {
                // Add day
                selectedDays.push(day);
                selectedDays.sort();
            }
            
            loadCalendar();
        }
        
        // Update current view info text
        function updateCurrentViewInfo() {
            const infoDiv = document.getElementById('current-view-info');
            
            if (filterMode === 'current') {
                const muscleGroups = userRoutine.routine_days[currentUserDay] || [];
                infoDiv.textContent = `Currently showing: Current Day (Day ${currentUserDay}) - ${muscleGroups.join(', ')}`;
            } else if (filterMode === 'all') {
                infoDiv.textContent = 'Currently showing: All Days';
            } else if (filterMode === 'specific') {
                const muscleGroupsSet = new Set();
                selectedDays.forEach(day => {
                    const groups = userRoutine.routine_days[day] || [];
                    groups.forEach(g => muscleGroupsSet.add(g));
                });
                const daysList = selectedDays.map(d => `Day ${d}`).join(', ');
                infoDiv.textContent = `Currently showing: ${daysList} - ${Array.from(muscleGroupsSet).join(', ')}`;
            }
        }
        
        // Get active days based on current filter mode
        function getActiveDays() {
            if (filterMode === 'current') {
                return [currentUserDay];
            } else if (filterMode === 'all') {
                const allDays = [];
                for (let i = 1; i <= userRoutine.days_per_week; i++) {
                    allDays.push(i);
                }
                return allDays;
            } else if (filterMode === 'specific') {
                return selectedDays;
            }
            return [];
        }
        
        // Get filtered exercises based on active days
        function getFilteredExercises() {
            const activeDays = getActiveDays();
            
            // Get all muscle groups for active days
            const muscleGroupsSet = new Set();
            activeDays.forEach(day => {
                const groups = userRoutine.routine_days[day] || [];
                groups.forEach(g => muscleGroupsSet.add(g));
            });
            
            // Filter exercises that match these muscle groups
            return allExercises.filter(ex => 
                muscleGroupsSet.has(ex.exercise_muscle_group)
            );
        }
        
        // Get filtered workout sessions based on active days
        function getFilteredSessions() {
            const activeDays = getActiveDays();
            
            // Only show sessions for the active days
            return workoutSessions.filter(session => 
                activeDays.includes(session.routine_day_number)
            );
        }
        
        // Build the calendar table
        function buildCalendarTable() {
            const headerRow = document.getElementById('header-row');
            const tbody = document.getElementById('calendar-body');
            
            // Update view info
            updateCurrentViewInfo();
            
            // Get filtered data
            const filteredExercises = getFilteredExercises();
            const filteredSessions = getFilteredSessions();
            
            // Clear and rebuild header
            headerRow.innerHTML = '';
            
            // Column 1: Exercise Name (fixed, wide)
            const nameHeader = document.createElement('th');
            nameHeader.textContent = 'Exercise Name';
            nameHeader.className = 'col-exercise-name';
            headerRow.appendChild(nameHeader);
            
            // Column 2: Next Workout (fixed)
            const nextWodHeader = document.createElement('th');
            nextWodHeader.textContent = 'Next Workout';
            nextWodHeader.className = 'col-next-workout';
            headerRow.appendChild(nextWodHeader);
            
            // Columns 3-12: Workout sessions (scrollable)
            for (let i = columnsToShow; i >= 1; i--) {
                const th = document.createElement('th');
                th.className = 'col-wod';
                
                const sessionIndex = columnsToShow - i;
                if (sessionIndex < filteredSessions.length) {
                    const session = filteredSessions[sessionIndex];
                    const date = new Date(session.workout_date);
                    const dayName = getDayName(date);
                    const dateStr = formatDateShort(date);
                    
                    th.innerHTML = `
                        <div style="font-size: 0.8rem; font-weight: normal;">${dayName}</div>
                        <div style="font-size: 0.85rem; font-weight: bold; margin-top: 0.2rem;">${dateStr}</div>
                    `;
                } else {
                    th.innerHTML = `
                        <div style="font-size: 0.85rem; font-weight: normal; color: #999;">[date]</div>
                    `;
                }
                headerRow.appendChild(th);
            }
            
            // Sort exercises by muscle group
            filteredExercises.sort((a, b) => {
                if (a.exercise_muscle_group !== b.exercise_muscle_group) {
                    return a.exercise_muscle_group.localeCompare(b.exercise_muscle_group);
                }
                return a.exercise_name.localeCompare(b.exercise_name);
            });
            
            tbody.innerHTML = '';
            
            if (filteredExercises.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="${2 + columnsToShow}" style="text-align: center; padding: 2rem; color: #999;">No exercises for selected day(s). Please add exercises in the Exercises page.</td>`;
                tbody.appendChild(emptyRow);
                return;
            }
            
            // Build rows
            let currentMuscle = null;
            filteredExercises.forEach(exercise => {
                // Add muscle group header if changed
                if (exercise.exercise_muscle_group !== currentMuscle) {
                    currentMuscle = exercise.exercise_muscle_group;
                    const muscleHeaderRow = document.createElement('tr');
                    muscleHeaderRow.className = 'muscle-header-row';
                    const muscleCell = document.createElement('td');
                    muscleCell.colSpan = 2 + columnsToShow;
                    muscleCell.textContent = currentMuscle;
                    muscleHeaderRow.appendChild(muscleCell);
                    tbody.appendChild(muscleHeaderRow);
                }
                
                const row = document.createElement('tr');
                
                // Column 1: Exercise Name
                const nameCell = document.createElement('td');
                nameCell.className = 'col-exercise-name';
                nameCell.textContent = exercise.exercise_name;
                row.appendChild(nameCell);
                
                // Column 2: Next Workout button
                const nextWodCell = document.createElement('td');
                nextWodCell.className = 'col-next-workout';
                
                const isSelected = nextWorkoutSelections[exercise.exercise_id] || false;
                const selectBtn = document.createElement('button');
                selectBtn.textContent = 'SELECT';
                selectBtn.className = isSelected ? 'btn-next-selected' : 'btn-next-unselected';
                selectBtn.addEventListener('click', async () => {
                    await toggleNextWorkoutSelection(exercise.exercise_id, !isSelected);
                    await loadCalendar();
                });
                nextWodCell.appendChild(selectBtn);
                row.appendChild(nextWodCell);
                
                // Columns 3-12: WOD sessions
                for (let i = 0; i < columnsToShow; i++) {
                    const cell = document.createElement('td');
                    cell.className = 'col-wod';
                    
                    if (i < filteredSessions.length) {
                        const session = filteredSessions[i];
                        const log = workoutLogs.find(log => 
                            log.exercise_id === exercise.exercise_id && 
                            log.session_id === session.session_id
                        );
                        
                        if (log) {
                            cell.textContent = log.sets_completed || '-';
                            cell.className = 'col-wod completed';
                        } else {
                            cell.textContent = '-';
                            cell.className = 'col-wod empty';
                        }
                    } else {
                        cell.textContent = '-';
                        cell.className = 'col-wod empty';
                    }
                    
                    row.appendChild(cell);
                }
                
                tbody.appendChild(row);
            });
        }
        
        // Toggle next workout selection
        async function toggleNextWorkoutSelection(exerciseId, isSelected) {
            const userId = getCurrentUserId();
            
            try {
                const response = await fetch(`${API_URL}/next-workout/toggle`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        exercise_id: exerciseId,
                        is_selected: isSelected
                    })
                });
                
                if (response.ok) {
                    nextWorkoutSelections[exerciseId] = isSelected;
                }
            } catch (error) {
                console.error('Error updating selection:', error);
            }
        }
        
        // Auto-generate next workout
        document.getElementById('generate-next-workout-btn').addEventListener('click', async () => {
            const userId = getCurrentUserId();
            const activeDays = getActiveDays();
            
            try {
                // Generate for all active days
                let totalSelected = 0;
                for (const day of activeDays) {
                    const response = await fetch(`${API_URL}/next-workout/generate/${userId}?day_number=${day}`, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        totalSelected += result.exercises_selected;
                    }
                }
                
                showMessage(`Next workout generated! ${totalSelected} exercises selected.`, 'success');
                await loadCalendar();
            } catch (error) {
                console.error('Error generating workout:', error);
                showMessage('Failed to generate workout', 'error');
            }
        });
        
        // Clear all selections
        document.getElementById('clear-selections-btn').addEventListener('click', async () => {
            const userId = getCurrentUserId();
            const activeDays = getActiveDays();
            
            try {
                // Clear for all active days
                for (const day of activeDays) {
                    await fetch(`${API_URL}/next-workout/clear/${userId}?day_number=${day}`, {
                        method: 'DELETE'
                    });
                }
                
                showMessage('Selections cleared', 'success');
                await loadCalendar();
            } catch (error) {
                console.error('Error clearing selections:', error);
            }
        });
        
        // Helper: Get day name
        function getDayName(date) {
            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            return days[date.getDay()];
        }
        
        // Helper: Format date
        function formatDateShort(date) {
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return months[date.getMonth()] + ' ' + date.getDate();
        }
        
        // Helper: Show message
        function showMessage(text, type) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = type === 'success' ? 'alert alert-success' : 'alert alert-danger';
            message.style.display = 'block';
            
            setTimeout(() => {
                message.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>